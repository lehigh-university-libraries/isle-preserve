# Decision Record for adding hocr support for printed text materials

Title: Decision for adding hocr support for printed text materials

## Context

A lot of content in The Preserve are paged content items. Meaning, `1` parent item with `N` children.

These paged content items use mirador IIIF viewer to display all children media. Adding hOCR support allows overlaying text on images shown in mirador.


## Decision

Use the Islandora community's provided solution for hOCR text overlay.

The first step for enabling hOCR text overlay in our instance was enabling two Drupal modules

- [Born-Digital-US/islandora_iiif_hocr](https://github.com/Born-Digital-US/islandora_iiif_hocr)
- [discoverygarden/islandora_hocr](https://github.com/discoverygarden/islandora_hocr)
  - [patched this so we only read the hOCR file during solr indexing](https://github.com/lehigh-university-libraries/isle-preserve/blob/main/drupal/rootfs/var/www/drupal/assets/patches/discoverygarden/islandora_hocr/index-only.patch)

```
composer require Born-Digital-US/islandora_iiif_hocr discoverygarden/islandora_hocr
drush en islandora_hocr islandora_iiif_hocr
drush migrate:import islandora_hocr_media_uses
```

Then we updated our IIIF Book manifest View to look for the new `https://discoverygarden.ca/use#hocr` term URI https://github.com/lehigh-university-libraries/isle-preserve/blob/270ef39f9088e7766639d84980cf7acc54f1ee37/drupal/rootfs/var/www/drupal/config/sync/views.view.iiif_manifest.yml#L632

### Dedicated hOCR solr index

We opted to [create a second solr index to store our hOCR documents](https://github.com/lehigh-university-libraries/isle-preserve/blob/main/drupal/rootfs/var/www/drupal/config/sync/search_api.index.hocr.yml). Since we do not index `Page` items in our main search index, this allowed us to index pages (and all other items with hOCR media) in a separate index from our main search index.

This solr index is queried in our `hocr` Drupal View which exposes an endpoint `annotations/%node` used by mirador to query hOCR documents for children in a paged content item https://github.com/lehigh-university-libraries/isle-preserve/blob/270ef39f9088e7766639d84980cf7acc54f1ee37/drupal/rootfs/var/www/drupal/config/sync/views.view.hocr.yml#L275

### Continue with community supported configuration

After we created our solr index and annotations view, we followed the instructions in [islandora/islandora_mirador module's README.md](https://github.com/islandora/islandora_mirador?tab=readme-ov-file#using-text-overlay) to setup text overlay, aside from the end of the documentation that specified creating a Drupal View querying media entities. The steps we followed are copied here from the README for clarity:

> To display a text overlay, Mirador must be provided with hOCR text data - which is OCR'd text that includes position information for the extracted text relative to the image that is being displayed. Here are the steps:
>
> 1. Ensure you're running isle-buildkit version 3.2.12 or above
> 2. Install the Drupal modules https://github.com/discoverygarden/islandora_hocr and https://github.com/Born-Digital-US/islandora_iiif_hocr
> 3. Create a derivative action so when Original File images are uploaded to your repository a file media entity is created with field_media_use equal to the hOCR media use term created by https://github.com/discoverygarden/islandora_hocr


### Enable dbmdz/solr-ocrhighlighting

Next, we enabled [the Solr OCR Highlighting Plugin](https://dbmdz.github.io/solr-ocrhighlighting/latest/) in our solr server by

- Set `SOLR_HOCR_PLUGIN_PATH` environment variable in our `.env` file https://github.com/lehigh-university-libraries/isle-preserve/blob/270ef39f9088e7766639d84980cf7acc54f1ee37/.env#L36
- Passed the variable to the drupal docker container https://github.com/lehigh-university-libraries/isle-preserve/blob/270ef39f9088e7766639d84980cf7acc54f1ee37/docker-compose.yaml#L278
- Passed the variable to php-fpm process https://github.com/lehigh-university-libraries/isle-preserve/blob/270ef39f9088e7766639d84980cf7acc54f1ee37/conf/php-fpm/www.conf#L23

Those steps allow [the solr config XML generated by discoverygarden/islandora_hocr](https://github.com/discoverygarden/islandora_hocr?tab=readme-ov-file#solr) to set the proper values in our solr server's config to enable [the Solr OCR Highlighting Plugin](https://dbmdz.github.io/solr-ocrhighlighting/latest/). The `solr-ocrhighlighting` library is already installed in [isle-buildkit's solr docker image](https://github.com/Islandora-Devops/isle-buildkit/blob/d094489238f2367a4e7949026320750bfb97e0b8/solr/Dockerfile#L10-L15), but the `SOLR_HOCR_PLUGIN_PATH` environment variable sets the proper solr server XML config to enable the plugin and provide an endpoint in solr to query hocr documents.

Phew! That is all. If you have hOCR media on a paged content item's children items, they should now be searchable through mirador.

### Search Results

We also wanted search results from our main search page to get passed to the paged content item. This way if a search result was from the OCR in a child item, it could be shown when viewing the item from the search results page. Should be noted this only works because we created aggregated PDFs of our paged content item children, which in turn creates OCR media on the paged content item, which is added to the search index. This setup will be in a future ADR.

Passing search results to the item view is done by appending the `search_api_fulltext` `GET` parameter to the item view URL for all search results: https://github.com/lehigh-university-libraries/isle-preserve/blob/270ef39f9088e7766639d84980cf7acc54f1ee37/drupal/rootfs/var/www/drupal/web/themes/custom/lehigh/js/node.js#L5-L10

Then, when rendering mirador for an item, if that search has a hit on our hOCR endpoint, the search is performed when mirador renders: https://github.com/lehigh-university-libraries/isle-preserve/blob/270ef39f9088e7766639d84980cf7acc54f1ee37/drupal/rootfs/var/www/drupal/web/themes/custom/lehigh/lehigh.theme#L544

We do this check to ensure the search match was actually from hOCR and not some other metadata.

## Rationale

This is more or less the community supported configuration for hOCR support, with an added feature of passing search results to item pages.

## Consequences

Positive:

- Improved paged content item display
- We can see exactly where some text might be on our paged content items

Negative:

- This does not support handwritten text materials
- the hOCR document is not easily generated our editable, so we have to take what we can get from tesseract
