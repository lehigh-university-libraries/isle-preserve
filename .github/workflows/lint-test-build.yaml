name: lint-test-build-push
on:
  push:
    branches:
      - "**"
    paths-ignore:
      - "**/*.md"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write

jobs:
  lint-test-build-push:
    # run on self hosted to take advantage of docker build cache
    # and composer cache
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - run: hadolint --verbose ./drupal/Dockerfile

      - name: composer install
        run: mkdir -p "${COMPOSER_HOME}" && composer install
        working-directory: codebase
        env:
          # let composer cache persist on container restarts
          # since we mount a docker volume on /app
          COMPOSER_HOME: /app/composer-cache

      - run: ./scripts/ci/lint.sh

      - name: Extract branch name as docker tag
        shell: bash
        run: |-
          TAG=$(echo "${GITHUB_REF#refs/heads/}" | sed 's/[^a-zA-Z0-9._-]//g' | awk '{print substr($0, length($0)-120)}')
          echo "tag=$TAG" >> $GITHUB_OUTPUT
        id: extract_tag

      - id: "auth"
        name: "Authenticate to Google Cloud"
        uses: "google-github-actions/auth@6fc4af4b145ae7821d527454aa9bd537d1f2dc5f" # v2
        with:
          workload_identity_provider: ${{ secrets.GCLOUD_OIDC_POOL }}
          create_credentials_file: true
          service_account: ${{ secrets.GSA }}
          token_format: "access_token"

      - uses: "docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567" # v3
        name: "Docker login"
        with:
          registry: "us-docker.pkg.dev"
          username: "oauth2accesstoken"
          password: "${{ steps.auth.outputs.access_token }}"

      - name: "build-push"
        run: |
          docker buildx create --name isle-builder --use || echo ""
          docker buildx build \
            --platform linux/amd64,linux/arm64/v8 \
            --push \
            -t us-docker.pkg.dev/${{ secrets.GCLOUD_PROJECT }}/isle/drupal:${{ steps.extract_tag.outputs.tag }} \
            drupal

  deploy-test:
    runs-on: self-hosted
    needs: [lint-test-build-push]
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - run: ./scripts/ci/trigger-rollout.sh
        env:
          ROLLOUT_URL: https://wight.cc.lehigh.edu/_rollout

      - run: ./scripts/ci/test.sh

  deploy-stage:
    runs-on: self-hosted
    needs: [deploy-test]
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - run: ./scripts/ci/trigger-rollout.sh
        env:
          ROLLOUT_URL: https://islandora-test.lib.lehigh.edu/_rollout
