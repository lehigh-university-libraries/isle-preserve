services:
  alpaca:
    environment:
      ALPACA_DERIVATIVE_FITS_URL: http://crayfits:8080
      ALPACA_DERIVATIVE_OCR_URL: http://hypercube:8080
      ALPACA_DERIVATIVE_HOMARUS_URL: http://homarus:8080
      ALPACA_DERIVATIVE_HOUDINI_URL: http://houdini:8080
      ALPACA_DERIVATIVE_LIBREOFFICE_URL: http://libreoffice:8080
      ALPACA_DERIVATIVE_WHISPER_URL: http://whisper:8080
      ALPACA_DERIVATIVE_OCRPDF_URL: http://ocrpdf:8080
      ALPACA_DERIVATIVE_HTR_URL: http://ocrpdf:8080
  cantaloupe:
    volumes:
      - cantaloupe-data:/data:Z,rw
  drupal:
    environment:
      LEHIGH_TRANSFORM_SERVICE_URI: "http://transformer:8080"
    volumes:
      - fcrepo-data:/fcrepo:r
      - ./drupal/rootfs/var/www/drupal:/var/www/drupal:z,rw,${CONSISTENCY}
  drupal-lehigh:
    environment:
      LEHIGH_TRANSFORM_SERVICE_URI: "http://transformer:8080"
    volumes:
      - fcrepo-data:/fcrepo:r
      - ./drupal/rootfs/var/www/drupal:/var/www/drupal:z,rw,${CONSISTENCY}

  fcrepo:
    volumes:
      - fcrepo-data:/data:Z,rw
  transformer:
    image: ghcr.io/lehigh-university-libraries/sentence-transformer:main@sha256:3463cf1178c367079970a8916b2671b0701dc80733126d799033851232723c18
  mariadb:
    image: mariadb:11.8.2-noble@sha256:2bcbaec92bd9d4f6591bc8103d3a8e6d0512ee2235506e47a2e129d190444405
    secrets:
      - source: DB_ROOT_PASSWORD
        target: MARIADB_ROOT_PASSWORD
    healthcheck:
      test: test /run/mysqld/mysqld.sock
    ports:
      - 3306:3306
  memcached:
    command: memcached -m 256 -I 5m
  parry:
    volumes:
      - ./conf/parry/scyllaridae.ci.yml:/app/scyllaridae.yml:r
  fits:
    image: islandora/fits:4.3.7@sha256:b94e650d940f5d798f5c2250102838e103c9d7e80562ff62aefd32bf0fb2da86
    volumes:
      - ./tmp/fits:/tmp:rw
  crayfits:
    image: ghcr.io/lehigh-university-libraries/scyllaridae-fits:main@sha256:78536d98eb326a294fb6975bbed521ff543a1d3275c20f1813866e922f30c776
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
    volumes:
      - ./tmp/crayfits:/tmp:rw
      - ./certs/rootCA.pem:/app/ca.pem:r
  hls:
    image: ghcr.io/lehigh-university-libraries/scyllaridae-hls:main@sha256:80930c87436cc70fed06498ce4a84df754d468727eff57fc91bf51bcef37d3c2
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
    volumes:
      - ./certs/rootCA.pem:/app/ca.pem:r
  homarus:
    image: ghcr.io/lehigh-university-libraries/scyllaridae-ffmpeg:main@sha256:7cf41638adf8c8a95b8edd141fd8a4be0052f6c1b708acdf80e1be3dfe10f96a
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
    volumes:
      - ./tmp/homarus:/tmp:rw
      - ./certs/rootCA.pem:/app/ca.pem:r
  houdini:
    image: ghcr.io/lehigh-university-libraries/scyllaridae-imagemagick:main@sha256:0137d2749b6ddbe7406814ddc29ab0d1a1c964630182098db7633088eaecac97
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
    volumes:
      - ./tmp/houdini:/tmp:rw
      - ./certs/rootCA.pem:/app/ca.pem:r
  hypercube:
    image: ghcr.io/lehigh-university-libraries/scyllaridae-tesseract:main@sha256:3870cb957fc0a778a602014114d086811d50d33328c95736bfca97cd4542263a
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
    volumes:
      - ./tmp/hypercube:/tmp:rw
      - ./certs/rootCA.pem:/app/ca.pem:r
  ocrpdf:
    image: ghcr.io/lehigh-university-libraries/scyllaridae-ocrpdf:main@sha256:3500c7137ae3215894792654d727a9a92655282319fce266e5bf2149f2122fbb
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
  libreoffice:
    image: ghcr.io/lehigh-university-libraries/scyllaridae-libreoffice:main@sha256:8a798f2aee91e6917f0607655fd216f01fe4307b9bc3b15a11ee6b0a633b8eab
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
    volumes:
      - ./certs/rootCA.pem:/app/ca.pem:r
  coverpage:
    image: ghcr.io/lehigh-university-libraries/scyllaridae-coverpage:main@sha256:058ea1733f4faae8e98a9520a28d72dc0af74252f06a0eef4e6a369d8b7c9396
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
    volumes:
      - ./certs/rootCA.pem:/app/ca.pem:r
  mergepdf:
    image: ghcr.io/lehigh-university-libraries/scyllaridae-mergepdf:main@sha256:0b58170638a5e538909789b1ccddfca226462e39b85b998cad71c7ca2cbefcbb
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
      MAX_THREADS: 3
    volumes:
      - ./certs/rootCA.pem:/app/ca.pem:r
  rollout:
    profiles: [donotstart]
  traefik:
    ports:
      - 8080:8080
