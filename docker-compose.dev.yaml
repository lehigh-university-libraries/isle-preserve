services:
  alpaca:
    environment:
      ALPACA_DERIVATIVE_FITS_URL: http://crayfits:8080
      ALPACA_DERIVATIVE_OCR_URL: http://hypercube:8080
      ALPACA_DERIVATIVE_HOMARUS_URL: http://homarus:8080
      ALPACA_DERIVATIVE_HOUDINI_URL: http://houdini:8080
      ALPACA_DERIVATIVE_LIBREOFFICE_URL: http://libreoffice:8080
      ALPACA_DERIVATIVE_WHISPER_URL: http://whisper:8080
      ALPACA_DERIVATIVE_OCRPDF_URL: http://ocrpdf:8080
      ALPACA_DERIVATIVE_HTR_URL: http://ocrpdf:8080
  cantaloupe:
    volumes:
      - cantaloupe-data:/data:Z,rw
  drupal:
    environment:
      LEHIGH_TRANSFORM_SERVICE_URI: "http://transformer:8080"
    volumes:
      - ./drupal/rootfs/var/www/drupal:/var/www/drupal:z,rw,${CONSISTENCY}
  drupal-lehigh:
    environment:
      LEHIGH_TRANSFORM_SERVICE_URI: "http://transformer:8080"
    volumes:
      - ./drupal/rootfs/var/www/drupal:/var/www/drupal:z,rw,${CONSISTENCY}
  transformer:
    image: ghcr.io/lehigh-university-libraries/sentence-transformer:main@sha256:3463cf1178c367079970a8916b2671b0701dc80733126d799033851232723c18
  mariadb:
    image: mariadb:11.8.3-noble@sha256:851a6020c97b9eae7736b6fb275800601d64635222054d3a1b1b3c4abdfa117a
    secrets:
      - source: DB_ROOT_PASSWORD
        target: MARIADB_ROOT_PASSWORD
    healthcheck:
      test: test /run/mysqld/mysqld.sock
    ports:
      - 3306:3306
  memcached:
    command: memcached -m 256 -I 5m
  parry:
    volumes:
      - ./conf/parry/scyllaridae.ci.yml:/app/scyllaridae.yml:r
  fits:
    image: islandora/fits:4.3.18@sha256:0486d476ee0090ccb46a735ca10c557e7db092fdde76e2f4744f95ca57759469
    volumes:
      - ./tmp/fits:/tmp:rw
  crayfits:
    image: ghcr.io/lehigh-university-libraries/scyllaridae-fits:main@sha256:9782c1c50f58e0bb36b341b969fd48aa79f15ae25913393e5d2a00ab34ef5abb
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
    volumes:
      - ./tmp/crayfits:/tmp:rw
      - ./certs/rootCA.pem:/app/ca.pem:r
  hls:
    image: ghcr.io/lehigh-university-libraries/scyllaridae-hls:main@sha256:3f5c692f7e3427602ca8c6bd6fb76f74bf313aacb69d1abaf38aab82e50bd075
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
    volumes:
      - ./certs/rootCA.pem:/app/ca.pem:r
  homarus:
    image: ghcr.io/lehigh-university-libraries/scyllaridae-ffmpeg:main@sha256:9fa508d61b3a33405d9f3c693e78b4a5b718170a1da24c9286669cf829f11c41
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
    volumes:
      - ./tmp/homarus:/tmp:rw
      - ./certs/rootCA.pem:/app/ca.pem:r
  houdini:
    image: ghcr.io/lehigh-university-libraries/scyllaridae-imagemagick:main@sha256:c2eb606f0dc31c121822c64a2e0f62d6717675325e662afacfc7b5eb9c957989
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
    volumes:
      - ./tmp/houdini:/tmp:rw
      - ./certs/rootCA.pem:/app/ca.pem:r
  hypercube:
    image: ghcr.io/lehigh-university-libraries/scyllaridae-tesseract:main@sha256:d0a889358110d569e8e3dc46d91125abf897854b558613de37c38b7f7879c2c1
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
    volumes:
      - ./tmp/hypercube:/tmp:rw
      - ./certs/rootCA.pem:/app/ca.pem:r
  ocrpdf:
    image: ghcr.io/lehigh-university-libraries/scyllaridae-ocrpdf:main@sha256:607c3e803677c5681c3f5e75486398b34b7ca2da0b394db8c8c08f5003399ad4
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
  libreoffice:
    image: ghcr.io/lehigh-university-libraries/scyllaridae-libreoffice:main@sha256:2fdd97905302e66f70d4f5d2804529e548493590b0905b1dd962f2ca8cbcd56d
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
    volumes:
      - ./certs/rootCA.pem:/app/ca.pem:r
  coverpage:
    image: ghcr.io/lehigh-university-libraries/scyllaridae-coverpage:main@sha256:1717fcd66dc640bba059386764f8c67151a5861438f6ce68041d900f5088cd71
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
    volumes:
      - ./certs/rootCA.pem:/app/ca.pem:r
  mergepdf:
    image: ghcr.io/lehigh-university-libraries/scyllaridae-mergepdf:main@sha256:075f15a9206d9d02d48359a23313475758c8f49d35da40b34fdbec29e5aa68fb
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
      MAX_THREADS: 3
    volumes:
      - ./certs/rootCA.pem:/app/ca.pem:r
  rollout:
    profiles: [donotstart]
  traefik:
    ports:
      - 8080:8080
