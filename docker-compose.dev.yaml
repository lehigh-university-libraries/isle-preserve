services:
  alpaca:
    environment:
      ALPACA_DERIVATIVE_FITS_URL: http://crayfits:8080
      ALPACA_DERIVATIVE_OCR_URL: http://hypercube:8080
      ALPACA_DERIVATIVE_HOMARUS_URL: http://homarus:8080
      ALPACA_DERIVATIVE_HOUDINI_URL: http://houdini:8080
      ALPACA_DERIVATIVE_LIBREOFFICE_URL: http://libreoffice:8080
      ALPACA_DERIVATIVE_WHISPER_URL: http://whisper:8080
      ALPACA_DERIVATIVE_OCRPDF_URL: http://ocrpdf:8080
      ALPACA_DERIVATIVE_HTR_URL: http://ocrpdf:8080
  cantaloupe:
    volumes:
      - cantaloupe-data:/data:Z,rw
  drupal:
    environment:
      LEHIGH_TRANSFORM_SERVICE_URI: "http://transformer:8080"
    volumes:
      - fcrepo-data:/fcrepo:r
      - ./drupal/rootfs/var/www/drupal:/var/www/drupal:z,rw,${CONSISTENCY}
  fcrepo:
    volumes:
      - fcrepo-data:/data:Z,rw
  transformer:
    image: ghcr.io/lehigh-university-libraries/sentence-transformer:main@sha256:d7219810daf842d75d70bf249cda1d455af864d9d37168ede4725ddd4af2a574
  mariadb:
    image: mariadb:11.7.2-noble@sha256:81e893032978c4bf8ad43710b7a979774ed90787fa32d199162148ce28fe3b76
    secrets:
      - source: DB_ROOT_PASSWORD
        target: MARIADB_ROOT_PASSWORD
    healthcheck:
      test: test /run/mysqld/mysqld.sock
    ports:
      - 3306:3306
  memcached:
    command: memcached -m 256 -I 5m
  parry:
    volumes:
      - ./conf/parry/scyllaridae.ci.yml:/app/scyllaridae.yml:r
  fits:
    image: islandora/fits:4.0.9@sha256:7df70e7068922d4a2f852c09f0e90643ab6fe410e17f73be96812050d501645e
    volumes:
      - ./tmp/fits:/tmp:rw
  crayfits:
    image: lehighlts/scyllaridae-fits:main@sha256:747e2ad82d60cab15199c50d1eec3addcb9744b4bd5c66e2d5e64e61347ed700
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
    volumes:
      - ./tmp/crayfits:/tmp:rw
      - ./certs/rootCA.pem:/app/ca.pem:r
  hls:
    image: lehighlts/scyllaridae-hls:main@sha256:0a796ca617ed5a4c69d1835a064d719ccb63afc77cfac790b5bb03146e6f92a7
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
    volumes:
      - ./certs/rootCA.pem:/app/ca.pem:r
  homarus:
    image: lehighlts/scyllaridae-ffmpeg:main@sha256:f739642cb9835e9483bd9a873d30e054875a10e9532553791a5b2c50807f2427
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
    volumes:
      - ./tmp/homarus:/tmp:rw
      - ./certs/rootCA.pem:/app/ca.pem:r
  houdini:
    image: lehighlts/scyllaridae-imagemagick:main@sha256:f1419bb6b2eddcc66071bdbaf90945864c40881eff9b8f27c482ffa0a11ee67e
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
    volumes:
      - ./tmp/houdini:/tmp:rw
      - ./certs/rootCA.pem:/app/ca.pem:r
  hypercube:
    image: lehighlts/scyllaridae-tesseract:main@sha256:e85421038a394efb5f6efb97cd517b6aaaef0193bd743b909a8efff225085f9b
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
    volumes:
      - ./tmp/hypercube:/tmp:rw
      - ./certs/rootCA.pem:/app/ca.pem:r
  ocrpdf:
    image: lehighlts/scyllaridae-ocrpdf:main@sha256:2e2d148cea8eee0de03a622e56e644fc6053b1c0555b1bc0bf42426cbec54995
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
  libreoffice:
    image: lehighlts/scyllaridae-libreoffice:main@sha256:1aa4cee0f0f8b765314e304c7b0fec34a2487553bcae94afb3502cff63852ef6
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
    volumes:
      - ./certs/rootCA.pem:/app/ca.pem:r
  coverpage:
    image: lehighlts/scyllaridae-coverpage:main@sha256:632a2f32fd19397120e6dfa745f1e244395651bdb62e562a3632bee75ed71f1a
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
    volumes:
      - ./certs/rootCA.pem:/app/ca.pem:r
  cache-warmer:
    image: lehighlts/scyllaridae-cache-warmer:main@sha256:908aee7dbf2db4ec186cd7712f0aa765cd9cbe522c713441cba19f9d1a4530e4
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
      DRUPAL_URL: "https://${DOMAIN}"
    volumes:
      - ./certs/rootCA.pem:/app/ca.pem:r
  mergepdf:
    image: lehighlts/scyllaridae-mergepdf:main@sha256:c6099c6b150965a6747f2d02a3217b0ee5d9cf6e5150948b56a13d0d81ad2f88
    environment:
      JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
      MAX_THREADS: 3
    volumes:
      - ./certs/rootCA.pem:/app/ca.pem:r
  rollout:
    profiles: [donotstart]
  traefik:
    ports:
      - 8080:8080
